########################################
######## CONTAINER ENVIRONMENTS ########
########################################

common_env_physics: &common_env_physics
    environment_type: 'docker-encapsulated'
    image: madminertool/docker-madminer-physics
    imagetag: 'latest'

common_env_ml: &common_env_ml
    environment_type: 'docker-encapsulated'
    image: madminertool/docker-madminer-ml
    imagetag: 'latest'


########################################
######## PHYSICS WORKFLOW STEPS ########
########################################

configurate:
  environment: *common_env_physics
  process:
    process_type: string-interpolated-cmd
    script: scripts/1_configurate.sh -p /madminer -i {input_file}
  publisher:
    publisher_type: 'fromglob-pub'
    outputkey: config_file
    globexpression: '*.h5' 

generate:
  environment: *common_env_physics
  process:
    process_type: string-interpolated-cmd
    script: scripts/2_generate.sh -p /madminer -s {signal_dir} -j {num_jobs} -c {config_file}
  publisher:
    publisher_type: 'fromglob-pub'
    outputkey: script_files
    globexpression: 'folder_*.tar.gz'

mg_pythia:
  environment: *common_env_physics
  process:
    process_type: string-interpolated-cmd
    script: scripts/3_pythia.sh -p /madminer -m {madgraph_dir} -s {signal_dir} -l {logs_dir} -z {events_folder}
  publisher:
    publisher_type: 'fromglob-pub'
    outputkey: postrun_file
    globexpression: 'Events.tar.gz'

delphes:
  environment: *common_env_physics
  process:
    process_type: string-interpolated-cmd
    script: scripts/4_delphes.sh -p /madminer -c {config_file} -i {input_file} -e {event_file}
  publisher:
    publisher_type: 'fromglob-pub'
    outputkey: dpostrun_file
    globexpression: 'madminer_delphes_data_*.h5'

combine:
  environment: *common_env_physics
  process:
    process_type: string-interpolated-cmd
    script: scripts/5_combine.sh -p /madminer -i {input_files}
  publisher:
    publisher_type: 'fromglob-pub'
    outputkey: data_file
    globexpression: 'combined_delphes.h5'


#######################################
########## ML WORKFLOW STEPS ##########
#######################################

sampling:
  environment: *common_env_ml
  process:
    process_type: interpolated-script-cmd
    script: |
      mkdir /madminer/data
      mkdir /madminer/data/samples
      python /madminer/code/configurate_ml.py {n_trainsamples} {data_file} {input_file}
      cd /madminer/data
      cp -R /madminer/data/Samples_* {sampleworkdir}
  publisher:
    publisher_type: 'fromglob-pub'
    outputkey: sampling_file
    globexpression: 'Samples_*'

training:
  environment: *common_env_ml
  process:
    process_type: interpolated-script-cmd 
    script: |
      mkdir /madminer/models
      cp -R {trainfolder} /madminer
      python /madminer/code/train.py /madminer/Samples_*/ {input_file}
      tar -czvf /madminer/Model.tar.gz /madminer/models
      cp -R /madminer/Model.tar.gz  {trainworkdir}
  publisher:
    publisher_type: 'fromglob-pub'
    outputkey: trained_file
    globexpression: 'Model.tar.gz'

evaluating:
  environment: *common_env_ml
  process:
    process_type: interpolated-script-cmd
    script: |
      mkdir /madminer/models
      mkdir /madminer/test
      mkdir /madminer/results
      mkdir /madminer/rates/
      tar -xvf {trained_file} -C /madminer/models --strip-components 2
      python /madminer/code/evaluation.py {input_file} /madminer/models/* {data_file}
      tar -czvf /madminer/Results.tar.gz /madminer/results /madminer/rates /madminer/test /madminer/models
      cp -R /madminer/Results.tar.gz  {evalworkdir}
      ls -lR
  publisher:
    publisher_type: interpolated-pub
    publish:
      results_file: '{evalworkdir}/Results.tar.gz'

plotting:
  environment: *common_env_ml
  process:
    process_type: interpolated-script-cmd
    script: |
      mkdir /madminer/plots
      echo hello
      for file in {results_file}; do tar -xvf "$file" -C .  --strip-components 1 ; done
      python /madminer/code/plotting.py {input_file} 
      ls -lR
      cp -R /madminer/plots {plotworkdir}
  publisher:
    publisher_type: interpolated-pub
    publish:
      outputfile: '{outputfile}'
